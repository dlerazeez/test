<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Assets & Expenses</title>
  <link rel="stylesheet" href="/static/style.css?v=200">
</head>
<body>

<div class="layout">

  <!-- Left sidebar -->
  <aside class="sidebar">
    <div class="sidebarTop">
      <div class="logo">Asset Service</div>
      <div class="small">Zoho Books</div>
    </div>

    <div class="nav">
      <button id="navAssets" class="navBtn hidden" type="button">Assets</button>
      <button id="navExpenses" class="navBtn active" type="button">Expenses</button>
    </div>

    <div class="navGroup">
      <div class="groupTitle">Expenses</div>
      <button id="btnCreateExpense" class="sideBtn" type="button">Create Expense</button>
      <button id="btnRetrieveExpenses" class="sideBtn" type="button">Retrieve Expenses</button>
      <button id="btnPendingExpenses" class="sideBtn" type="button">Pending Expenses</button>
    </div>

    </aside>

  <!-- Main content -->
  <main class="content">

    <section id="blankSection" class="section hidden">
      <div class="card">
        <h1>Choose a module</h1>
        <p class="muted">Select Assets or Expenses from the left.</p>
      </div>
    </section>

    <!-- ASSETS SECTION (kept but hidden in nav; safe to ignore) -->
    <section id="assetsSection" class="section hidden">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h1>Create Fixed Asset</h1>
            <div class="subtitle">Draft asset will be created in Zoho Books</div>
          </div>
          <div class="badge">Assets</div>
        </div>

        <div class="hr"></div>

        <form id="assetForm" class="formGrid">
          <div class="field">
            <label>Asset Name</label>
            <input id="asset_name" required />
          </div>

          <div class="field">
            <label>Purchase Date</label>
            <input id="purchase_date" type="date" />
          </div>

          <div class="field">
            <label>Cost</label>
            <input id="cost" type="number" step="0.01" />
          </div>

          <div class="field">
            <label>Vendor Name</label>
            <input id="asset_vendor_name" />
          </div>

          <div class="field">
            <label>Description</label>
            <textarea id="asset_description" rows="3"></textarea>
          </div>

          <div class="actions">
            <button id="assetSubmitBtn" type="submit" class="primary">Create Asset</button>
          </div>
        </form>

        <div id="assetResult" class="result hidden"></div>
      </div>
    </section>

    <!-- EXPENSES SECTION -->
    <section id="expensesSection" class="section">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h1>Expenses</h1>
            <div class="subtitle">Create / Retrieve / Pending (Local)</div>
          </div>
          <div class="badge">Expenses</div>
        </div>

        <div class="hr"></div>

        <!-- Tabs inside Expenses -->
        <div class="tabs">
          <button id="tabCreate" class="tab active" type="button">Create</button>
          <button id="tabRetrieve" class="tab" type="button">Retrieve</button>
          <button id="tabPending" class="tab" type="button">Pending</button>
        </div>

        <!-- CREATE PANEL -->
        <div id="panelCreate" class="panel">
          <form id="expenseForm" class="formGrid">
            <div class="field">
              <label>Date</label>
              <input id="expense_date" type="date" required />
            </div>

            <div class="field">
              <label>Amount</label>
              <input id="expense_amount" type="number" step="0.01" required />
            </div>

            <div class="field">
              <label>Currency</label>
              <select id="expense_currency">
                <option value="IQD" selected>IQD</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>

            <div class="field">
              <label>Vendor</label>
              <select id="vendor_id">
                <option value="">-- Select vendor (optional) --</option>
              </select>
              <div class="hint">Loaded from Zoho vendors (Contacts)</div>
            </div>

            <div class="field">
              <label>Vendor Name (manual)</label>
              <input id="vendor_name" placeholder="Optional" />
              <div class="hint">If vendor is not in the dropdown, type it here.</div>
            </div>

            <div class="field">
              <label>Reference</label>
              <input id="expense_reference" placeholder="Optional" />
            </div>

            <div class="field">
              <label>Description / Notes</label>
              <textarea id="expense_description" rows="3" placeholder="Optional"></textarea>
            </div>

            <div class="field">
              <label>Expense Account</label>
              <select id="expense_account_id"></select>
              <div class="hint">Loaded from Chart_of_Accounts.csv</div>
            </div>

            <div class="field">
              <label>Paid Through (Cash/Bank)</label>
              <select id="paid_through_account_id"></select>
              <div class="hint">Loaded from Chart_of_Accounts.csv</div>
            </div>

            <div class="field">
              <label>Receipt (optional)</label>
              <input id="expense_receipt" type="file" />
            </div>

            <div class="actions">
              <button id="expenseSubmitBtn" type="submit" class="primary">Save as Pending</button>
            </div>
          </form>

          <div id="expenseResult" class="result hidden"></div>
        </div>

        <!-- RETRIEVE PANEL -->
        <div id="panelRetrieve" class="panel hidden">
          <div class="row">
            <div class="field">
              <label>From</label>
              <input id="zoho_from" type="date" />
            </div>
            <div class="field">
              <label>To</label>
              <input id="zoho_to" type="date" />
            </div>
            <div class="field grow">
              <label>Search</label>
              <input id="zoho_search" placeholder="Vendor / Reference / Notes (optional)" />
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button id="expenseListBtn" class="secondary" type="button">Retrieve</button>
            </div>
          </div>

          <div id="zohoResult" class="result hidden"></div>
          <div id="zohoList" class="list"></div>
        </div>

        <!-- PENDING PANEL -->
        <div id="panelPending" class="panel hidden">
          <div class="row">
            <div class="field">
              <label>From</label>
              <input id="pending_from" type="date" />
            </div>
            <div class="field">
              <label>To</label>
              <input id="pending_to" type="date" />
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button id="pendingListBtn" class="secondary" type="button">Retrieve</button>
            </div>
          </div>

          <div id="pendingResult" class="result hidden"></div>
          <div id="pendingList" class="list"></div>
        </div>

      </div>
    </section>

  </main>
</div>

<!-- EXPENSE EDIT MODAL -->
<div id="expenseEditModal" class="modal hidden">
  <div id="expenseEditBackdrop" class="backdrop"></div>
  <div class="modalCard">
    <div class="modalHeader">
      <div>
        <div class="modalTitle">Edit Zoho Expense</div>
        <div class="modalSubtitle">Update fields and save back to Zoho Books</div>
      </div>
      <button id="expenseEditClose" class="iconBtn" type="button">×</button>
    </div>

    <div class="hr"></div>

    <div class="modalBody">
      <div class="formGrid">
        <div class="field">
          <label>Date</label>
          <input id="edit_expense_date" type="date" />
        </div>

        <div class="field">
          <label>Amount</label>
          <input id="edit_expense_amount" type="number" step="0.01" />
        </div>

        <div class="field">
          <label>Vendor</label>
          <select id="edit_vendor_id"></select>
        </div>

        <div class="field">
          <label>Reference</label>
          <input id="edit_reference_number" />
        </div>

        <div class="field">
          <label>Description / Notes</label>
          <textarea id="edit_description" rows="3"></textarea>
        </div>

        <div class="field">
          <label>Expense Account</label>
          <select id="edit_expense_account_id"></select>
        </div>

        <div class="field">
          <label>Paid Through</label>
          <select id="edit_expense_paid_through_account_id"></select>
        </div>

        <div class="field">
          <label>Receipt (upload to Zoho)</label>
          <input id="zohoAttachFile" type="file" />
          <div class="hint">This adds a new attachment (does not overwrite)</div>
        </div>

      </div>

      <div id="expenseEditMsg" class="result hidden"></div>

      <div class="actions spread">
        <div>
          <button id="expenseDeleteBtn" class="danger" type="button">Delete</button>
        </div>
        <div class="rightActions">
          <button id="expenseSaveBtn" class="primary" type="button">Save</button>
        </div>
      </div>

    </div>
  </div>
</div>


<!-- PENDING EDIT MODAL -->
<div id="pendingEditModal" class="modal hidden">
  <div id="pendingEditBackdrop" class="backdrop"></div>
  <div class="modalCard">
    <div class="modalHeader">
      <div>
        <div class="modalTitle">Edit Pending Expense</div>
        <div class="modalSubtitle">Update the pending expense, approve (post to Zoho), or delete it.</div>
      </div>
      <button id="pendingEditClose" class="mini" type="button">Close</button>
    </div>

    <div id="pendingEditMsg" class="result hidden"></div>

    <div class="formGrid">
      <div class="field">
        <label>Date</label>
        <input id="pedit_date" type="date" />
      </div>

      <div class="field">
        <label>Amount</label>
        <input id="pedit_amount" type="number" step="0.01" />
      </div>

      <div class="field">
        <label>Vendor</label>
        <select id="pedit_vendor_id">
          <option value="">-- Select vendor --</option>
        </select>
      </div>

      <div class="field">
        <label>Vendor Name (manual)</label>
        <input id="pedit_vendor_name" placeholder="Optional" />
      </div>

      <div class="field">
        <label>Reference</label>
        <input id="pedit_reference" placeholder="Optional" />
      </div>

      <div class="field">
        <label>Notes</label>
        <textarea id="pedit_notes" rows="3" placeholder="Optional"></textarea>
      </div>

      <div class="field">
        <label>Expense Account</label>
        <select id="pedit_account_id"></select>
      </div>

      <div class="field">
        <label>Paid Through</label>
        <select id="pedit_paid_through_account_id"></select>
      </div>
    </div>

    <div class="modalFooter">
      <button id="pendingSaveBtn" class="primary" type="button">Save</button>
      <button id="pendingApproveBtn" class="primary" type="button">Approve / Post to Zoho</button>
      <button id="pendingDeleteBtn" class="danger" type="button">Delete</button>
      <button id="pendingCloseBtn" class="mini" type="button">Close</button>
    </div>
  </div>
</div>

<script>
  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function showResult(el, kind, msg) {
    el.classList.remove("hidden");
    el.classList.remove("success", "error", "info");
    el.classList.add(kind);
    el.textContent = msg;
  }

  function hideResult(el) {
    el.classList.add("hidden");
    el.textContent = "";
  }

  const blankSection = document.getElementById("blankSection");
  const assetsSection = document.getElementById("assetsSection");
  const expensesSection = document.getElementById("expensesSection");
  const navAssets = document.getElementById("navAssets");
  const navExpenses = document.getElementById("navExpenses");

  function setActive(btn) {
    [navAssets, navExpenses].forEach(x => x.classList.remove("active"));
    btn.classList.add("active");
  }

  function showOnly(section) {
    [blankSection, assetsSection, expensesSection].forEach(s => s.classList.add("hidden"));
    section.classList.remove("hidden");
  }

  navAssets.addEventListener("click", () => {
    setActive(navAssets);
    showOnly(assetsSection);
  });

  navExpenses.addEventListener("click", () => {
    setActive(navExpenses);
    showOnly(expensesSection);
    showPanel(panelCreate);
  });

  // Expense tabs
  const tabCreate = document.getElementById("tabCreate");
  const tabRetrieve = document.getElementById("tabRetrieve");
  const tabPending = document.getElementById("tabPending");
  const panelCreate = document.getElementById("panelCreate");
  const panelRetrieve = document.getElementById("panelRetrieve");
  const panelPending = document.getElementById("panelPending");

  function showPanel(panel) {
    [panelCreate, panelRetrieve, panelPending].forEach(p => p.classList.add("hidden"));
    panel.classList.remove("hidden");
    [tabCreate, tabRetrieve, tabPending].forEach(t => t.classList.remove("active"));
    if (panel === panelCreate) tabCreate.classList.add("active");
    if (panel === panelRetrieve) tabRetrieve.classList.add("active");
    if (panel === panelPending) tabPending.classList.add("active");
  }

  tabCreate.addEventListener("click", () => showPanel(panelCreate));
  tabRetrieve.addEventListener("click", () => showPanel(panelRetrieve));
  tabPending.addEventListener("click", () => showPanel(panelPending));

  document.getElementById("btnCreateExpense").addEventListener("click", async () => {
    showPanel(panelCreate);
    try { await populateVendorsSelect(""); } catch (e) { /* ignore */ }
  });

  // IMPORTANT: Always reset to current month when opening Retrieve Expenses (as requested)
  document.getElementById("btnRetrieveExpenses").addEventListener("click", async () => {
    showPanel(panelRetrieve);
    const dfEl = document.getElementById("zoho_from");
    const dtEl = document.getElementById("zoho_to");
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    dfEl.value = `${yyyy}-${mm}-01`;
    dtEl.value = `${yyyy}-${mm}-${dd}`;
    await loadZohoExpenses();
  });

  // IMPORTANT: Show ALL pendings when clicking Pending Expenses (date filters optional)
  document.getElementById("btnPendingExpenses").addEventListener("click", async () => {
    showPanel(panelPending);
    const pf = document.getElementById("pending_from");
    const pt = document.getElementById("pending_to");
    pf.value = "";
    pt.value = "";
    await loadPending();
  });

  // Default panel
  showPanel(panelCreate);

  // Assets (safe to ignore)
  const assetForm = document.getElementById("assetForm");
  const assetResult = document.getElementById("assetResult");
  assetForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideResult(assetResult);
    try {
      const payload = {
        asset_name: document.getElementById("asset_name").value,
        purchase_date: document.getElementById("purchase_date").value,
        cost: document.getElementById("cost").value,
        vendor_name: document.getElementById("asset_vendor_name").value,
        description: document.getElementById("asset_description").value,
      };
      const res = await fetch("/assets/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
      showResult(assetResult, "success", "Asset created: " + (out.fixed_asset?.asset_number || "OK"));
    } catch (err) {
      showResult(assetResult, "error", String(err));
    }
  });

  // COA dropdowns
  async function loadCOA() {
    const res = await fetch("/coa/accounts");
    const out = await res.json();
    if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
    return out.accounts;
  }

  function fillSelect(selectEl, items, opts = {}) {
    const placeholder = opts.placeholder || "-- Select --";
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);

    for (const it of items) {
      const opt = document.createElement("option");
      opt.value = it.account_id;
      opt.textContent = `${it.account_name} (${it.account_code || ""})`.trim();
      selectEl.appendChild(opt);
    }
  }

  let cachedCOA = null;
  async function ensureCOALoaded() {
    if (cachedCOA) return cachedCOA;
    const accounts = await loadCOA();
    cachedCOA = accounts;
    return cachedCOA;
  }

  async function initExpenseDropdowns() {
    const accounts = await ensureCOALoaded();
    const expenseAccounts = accounts.filter(a => a.type === "Expense");
    const cashBank = accounts.filter(a => a.type === "Cash" || a.type === "Bank");

    fillSelect(document.getElementById("expense_account_id"), expenseAccounts, { placeholder: "Select expense account" });
    fillSelect(document.getElementById("paid_through_account_id"), cashBank, { placeholder: "Select cash/bank account" });

    fillSelect(document.getElementById("edit_expense_account_id"), expenseAccounts, { placeholder: "Select expense account" });
    fillSelect(document.getElementById("edit_expense_paid_through_account_id"), cashBank, { placeholder: "Select cash/bank account" });
  }

  initExpenseDropdowns().catch(console.error);

  // Create expense (Pending save)
  const expenseForm = document.getElementById("expenseForm");
  const expenseResult = document.getElementById("expenseResult");

  if (createVendorId && createVendorName) {
    createVendorId.addEventListener("change", () => {
      const sel = createVendorId.options[createVendorId.selectedIndex];
      if (createVendorId.value && sel && sel.textContent) {
        // Only auto-fill if empty or previously auto-filled
        if (!createVendorName.value) createVendorName.value = sel.textContent;
      }
    });
  }

  expenseForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideResult(expenseResult);

    try {
      const fd = new FormData();
      const payload = {
        date: document.getElementById("expense_date").value,
        amount: Number(document.getElementById("expense_amount").value || 0),
        currency: document.getElementById("expense_currency").value,
        vendor_id: (document.getElementById("vendor_id")?.value || ""),
        vendor_name: document.getElementById("vendor_name").value || "",
        reference: document.getElementById("expense_reference").value || "",
        notes: document.getElementById("expense_description").value || "",
        account_id: document.getElementById("expense_account_id").value || "",
        paid_through_account_id: document.getElementById("paid_through_account_id").value || "",
      };

      const res = await fetch("/pending-expenses/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));

      // Upload receipt to pending (optional)
      const fileEl = document.getElementById("expense_receipt");
      const file = fileEl.files?.[0];
      if (file) {
        const fd2 = new FormData();
        fd2.append("file", file);
        await fetch(`/pending-expenses/${encodeURIComponent(out.pending.id)}/attachments`, {
          method: "POST",
          body: fd2
        });
      }

      showResult(expenseResult, "success", "Saved as pending expense.");
      fileEl.value = "";
      await loadPending(); // refresh list if user is on pending tab later
    } catch (err) {
      showResult(expenseResult, "error", String(err));
    }
  });

  // Retrieve Zoho Expenses
  const zohoList = document.getElementById("zohoList");
  const zohoResult = document.getElementById("zohoResult");
  const expenseListBtn = document.getElementById("expenseListBtn");

  expenseListBtn.addEventListener("click", loadZohoExpenses);

  async function loadZohoExpenses() {
    hideResult(zohoResult);
    zohoList.innerHTML = "";

    const df = document.getElementById("zoho_from").value || "";
    const dt = document.getElementById("zoho_to").value || "";
    const search = document.getElementById("zoho_search").value || "";

    const qs = new URLSearchParams();
    qs.set("page", "1");
    qs.set("per_page", "200");
    qs.set("filter_by", "Status.All");
    if (search) qs.set("search_text", search);
    if (df) qs.set("date_from", df);
    if (dt) qs.set("date_to", dt);

    try {
      const res = await fetch("/expenses/list?" + qs.toString());
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
      renderZohoExpenses(out.expenses || []);
      showResult(zohoResult, "info", `Loaded ${out.count || (out.expenses || []).length} expenses.`);
    } catch (err) {
      showResult(zohoResult, "error", String(err));
    }
  }

  function renderZohoExpenses(rows) {
    zohoList.innerHTML = "";
    if (!rows.length) {
      zohoList.innerHTML = `<div class="empty">No expenses found.</div>`;
      return;
    }

    for (const r of rows) {
      const div = document.createElement("div");
      div.className = "listRow";

      const left = document.createElement("div");
      left.className = "rowMain";
      left.innerHTML = `
        <div class="rowTitle">${escapeHtml(r.vendor_name || "Expense")}</div>
        <div class="rowMeta">
          <span>${escapeHtml(r.date || "")}</span>
          <span class="dot">•</span>
          <span>${escapeHtml(String(r.total || r.amount || ""))} ${escapeHtml(r.currency_code || "")}</span>
          <span class="dot">•</span>
          <span>${escapeHtml(r.reference_number || "")}</span>
        </div>
      `;

      const actions = document.createElement("div");
      actions.className = "rowActions";
      actions.innerHTML = `
        <button class="mini" type="button" data-id="${escapeHtml(r.expense_id)}">View/Edit</button>
      `;

      actions.querySelector("button").addEventListener("click", () => openExpenseEditor(r.expense_id));

      div.appendChild(left);
      div.appendChild(actions);
      zohoList.appendChild(div);
    }
  }

  // Pending list
  const pendingList = document.getElementById("pendingList");
  const pendingResult = document.getElementById("pendingResult");
  document.getElementById("pendingListBtn").addEventListener("click", loadPending);

  async function loadPending() {
    hideResult(pendingResult);
    pendingList.innerHTML = "";

    const df = document.getElementById("pending_from").value || "";
    const dt = document.getElementById("pending_to").value || "";

    const qs = new URLSearchParams();
    if (df) qs.set("date_from", df);
    if (dt) qs.set("date_to", dt);

    try {
      const res = await fetch("/pending-expenses/list?" + qs.toString());
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
      renderPending(out.pending || []);
      showResult(pendingResult, "info", `Loaded ${out.count || (out.pending || []).length} pending expenses.`);
    } catch (err) {
      showResult(pendingResult, "error", String(err));
    }
  }

  function renderPending(rows) {
    pendingList.innerHTML = "";
    if (!rows.length) {
      pendingList.innerHTML = `<div class="empty">No pending expenses.</div>`;
      return;
    }

    for (const r of rows) {
      const div = document.createElement("div");
      div.className = "listRow";
      div.innerHTML = `
        <div class="rowMain">
          <div class="rowTitle">${escapeHtml(r.vendor_name || "Pending")}</div>
          <div class="rowMeta">
            <span>${escapeHtml(r.date || "")}</span>
            <span class="dot">•</span>
            <span>${escapeHtml(String(r.amount || ""))} ${escapeHtml(r.currency || "")}</span>
            <span class="dot">•</span>
            <span>${escapeHtml(r.reference_number || r.reference || "")}</span>
            <span class="dot">•</span>
            <span>${escapeHtml(r.status || "")}</span>
          </div>
        </div>

        <div class="rowActions">
          <button class="mini" type="button" data-action="pedit" data-id="${escapeHtml(String(r.id))}">View/Edit</button>
          <button class="mini" type="button" data-action="papprove" data-id="${escapeHtml(String(r.id))}">Approve</button>
          <button class="mini danger" type="button" data-action="pdelete" data-id="${escapeHtml(String(r.id))}">Delete</button>
        </div>
      `;
      pendingList.appendChild(div);
    }
  }

  
  // Pending Edit Modal
  const pendingEditModal = document.getElementById("pendingEditModal");
  const pendingEditBackdrop = document.getElementById("pendingEditBackdrop");
  const pendingEditClose = document.getElementById("pendingEditClose");
  const pendingEditMsg = document.getElementById("pendingEditMsg");
  const pendingSaveBtn = document.getElementById("pendingSaveBtn");
  const pendingApproveBtn = document.getElementById("pendingApproveBtn");
  const pendingDeleteBtn = document.getElementById("pendingDeleteBtn");
  const pendingCloseBtn = document.getElementById("pendingCloseBtn");

  const peditDate = document.getElementById("pedit_date");
  const peditAmount = document.getElementById("pedit_amount");
  const peditVendorId = document.getElementById("pedit_vendor_id");
  const peditVendorName = document.getElementById("pedit_vendor_name");
  const peditReference = document.getElementById("pedit_reference");
  const peditNotes = document.getElementById("pedit_notes");
  const peditAccountId = document.getElementById("pedit_account_id");
  const peditPaidThroughId = document.getElementById("pedit_paid_through_account_id");

  let currentPendingId = null;

  function showPendingEditModal() {
    pendingEditModal.classList.remove("hidden");
    pendingEditBackdrop.classList.remove("hidden");
  }
  function hidePendingEditModal() {
    pendingEditModal.classList.add("hidden");
    pendingEditBackdrop.classList.add("hidden");
    currentPendingId = null;
    hideResult(pendingEditMsg);
  }

  async function openPendingEditor(pendingId) {
    hideResult(pendingEditMsg);
    currentPendingId = pendingId;

    try {
      await populateVendorsSelect("");
      await loadCOA(); // ensure COA is ready

      // populate COA in pending edit selects
      peditAccountId.innerHTML = document.getElementById("expense_account_id").innerHTML;
      peditPaidThroughId.innerHTML = document.getElementById("paid_through_account_id").innerHTML;

      const res = await fetch("/pending-expenses/" + encodeURIComponent(pendingId));
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));

      const p = out.pending || {};
      peditDate.value = p.date || "";
      peditAmount.value = p.amount || "";
      peditVendorName.value = p.vendor_name || "";
      peditReference.value = p.reference || p.reference_number || "";
      peditNotes.value = p.notes || "";
      if (peditVendorId) peditVendorId.value = p.vendor_id || "";
      if (p.account_id) peditAccountId.value = p.account_id;
      if (p.paid_through_account_id) peditPaidThroughId.value = p.paid_through_account_id;

      showPendingEditModal();
    } catch (err) {
      showResult(pendingEditMsg, "error", String(err));
      showPendingEditModal();
    }
  }

  async function savePendingEdits() {
    if (!currentPendingId) return;
    hideResult(pendingEditMsg);

    const payload = {
      date: peditDate.value,
      amount: Number(peditAmount.value || 0),
      vendor_id: peditVendorId ? peditVendorId.value : "",
      vendor_name: peditVendorName.value || "",
      reference: peditReference.value || "",
      notes: peditNotes.value || "",
      account_id: peditAccountId.value || "",
      paid_through_account_id: peditPaidThroughId.value || "",
      currency: "IQD",
    };

    try {
      const res = await fetch("/pending-expenses/" + encodeURIComponent(currentPendingId), {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
      showResult(pendingEditMsg, "info", "Saved.");
      await loadPending();
    } catch (err) {
      showResult(pendingEditMsg, "error", String(err));
    }
  }

  async function approvePending() {
    if (!currentPendingId) return;
    const ok = confirm("Approve this pending expense and post it to Zoho?");
    if (!ok) return;

    hideResult(pendingEditMsg);
    try {
      const res = await fetch("/pending-expenses/" + encodeURIComponent(currentPendingId) + "/approve", { method: "POST" });
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
      showResult(pendingEditMsg, "info", "Approved and posted to Zoho.");
      await loadPending();
    } catch (err) {
      showResult(pendingEditMsg, "error", String(err));
    }
  }

  async function deletePending() {
    if (!currentPendingId) return;
    const ok = confirm("Delete this pending expense? This cannot be undone.");
    if (!ok) return;

    hideResult(pendingEditMsg);
    try {
      const res = await fetch("/pending-expenses/" + encodeURIComponent(currentPendingId), { method: "DELETE" });
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
      showResult(pendingEditMsg, "info", "Deleted.");
      await loadPending();
      setTimeout(hidePendingEditModal, 500);
    } catch (err) {
      showResult(pendingEditMsg, "error", String(err));
    }
  }

  // Pending list actions (delegate)
  pendingList.addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button[data-action]");
    if (!btn) return;
    const act = btn.getAttribute("data-action");
    const id = btn.getAttribute("data-id");
    if (!id) return;

    if (act === "pedit") {
      await openPendingEditor(id);
    } else if (act === "papprove") {
      const ok = confirm("Approve this pending expense and post it to Zoho?");
      if (!ok) return;
      try {
        const res = await fetch("/pending-expenses/" + encodeURIComponent(id) + "/approve", { method: "POST" });
        const out = await res.json();
        if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
        await loadPending();
        showResult(pendingResult, "info", "Approved and posted to Zoho.");
      } catch (err) {
        showResult(pendingResult, "error", String(err));
      }
    } else if (act === "pdelete") {
      const ok = confirm("Delete this pending expense? This cannot be undone.");
      if (!ok) return;
      try {
        const res = await fetch("/pending-expenses/" + encodeURIComponent(id), { method: "DELETE" });
        const out = await res.json();
        if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
        await loadPending();
        showResult(pendingResult, "info", "Deleted.");
      } catch (err) {
        showResult(pendingResult, "error", String(err));
      }
    }
  });

  pendingEditBackdrop.addEventListener("click", hidePendingEditModal);
  pendingEditClose.addEventListener("click", hidePendingEditModal);
  pendingCloseBtn.addEventListener("click", hidePendingEditModal);
  pendingSaveBtn.addEventListener("click", savePendingEdits);
  pendingApproveBtn.addEventListener("click", approvePending);
  pendingDeleteBtn.addEventListener("click", deletePending);


// Expense Edit Modal
  const expenseEditModal = document.getElementById("expenseEditModal");
  const expenseEditBackdrop = document.getElementById("expenseEditBackdrop");
  const expenseEditClose = document.getElementById("expenseEditClose");
  const expenseEditMsg = document.getElementById("expenseEditMsg");

  const editExpenseDate = document.getElementById("edit_expense_date");
  const editExpenseAmount = document.getElementById("edit_expense_amount");
  const editVendorId = document.getElementById("edit_vendor_id");
  const editReferenceNumber = document.getElementById("edit_reference_number");
  const editDescription = document.getElementById("edit_description");
  const editExpenseAccount = document.getElementById("edit_expense_account_id");
  const editExpensePaidThrough = document.getElementById("edit_expense_paid_through_account_id");

  const expenseSaveBtn = document.getElementById("expenseSaveBtn");
  const expenseDeleteBtn = document.getElementById("expenseDeleteBtn");

  let currentEditExpenseId = null;
  let cachedVendors = null;
  const createVendorId = document.getElementById("vendor_id");
  const createVendorName = document.getElementById("vendor_name");


  function hideExpenseEditModal() {
    expenseEditMsg.classList.add("hidden");
    expenseEditModal.classList.add("hidden");
    currentEditExpenseId = null;
  }

  function showExpenseEditModal() {
    expenseEditModal.classList.remove("hidden");
  }

  expenseEditClose.addEventListener("click", hideExpenseEditModal);
  expenseEditBackdrop.addEventListener("click", hideExpenseEditModal);

  async function ensureVendorsLoaded() {
    if (cachedVendors) return cachedVendors;
    const res = await fetch("/vendors/list?page=1&per_page=200");
    const out = await res.json();
    if (!res.ok || !out.ok) throw new Error(JSON.stringify(out, null, 2));
    cachedVendors = out.vendors || [];
    return cachedVendors;
  }

  async function populateVendorsSelect(selectedId) {
    const vendors = await ensureVendorsLoaded();

    // Edit Zoho expense modal select
    if (typeof editVendorId !== "undefined" && editVendorId) {
      editVendorId.innerHTML = `<option value="">-- Select vendor --</option>`;
      for (const v of vendors) {
        const opt = document.createElement("option");
        opt.value = v.vendor_id;
        opt.textContent = v.vendor_name;
        if (selectedId && String(selectedId) === String(v.vendor_id)) opt.selected = true;
        editVendorId.appendChild(opt);
      }
    }

    // Create pending expense select
    if (createVendorId) {
      createVendorId.innerHTML = `<option value="">-- Select vendor (optional) --</option>`;
      for (const v of vendors) {
        const opt = document.createElement("option");
        opt.value = v.vendor_id;
        opt.textContent = v.vendor_name;
        createVendorId.appendChild(opt);
      }
    }

    // Pending edit modal select
    const peditVendorIdEl = document.getElementById("pedit_vendor_id");
    if (peditVendorIdEl) {
      peditVendorIdEl.innerHTML = `<option value="">-- Select vendor --</option>`;
      for (const v of vendors) {
        const opt = document.createElement("option");
        opt.value = v.vendor_id;
        opt.textContent = v.vendor_name;
        peditVendorIdEl.appendChild(opt);
      }
    }
  }

  async function openExpenseEditor(expenseId) {
    hideResult(expenseEditMsg);
    currentEditExpenseId = expenseId;

    const res = await fetch("/expenses/by-id/" + encodeURIComponent(expenseId));
    const out = await res.json();
    if (!res.ok || !out.ok) {
      showResult(expenseEditMsg, "error", "Failed to load expense:\n" + JSON.stringify(out, null, 2));
      showExpenseEditModal();
      return;
    }

    const e = out.expense || {};

    editExpenseDate.value = e.date || "";
    editExpenseAmount.value = e.total || e.amount || "";
    editReferenceNumber.value = e.reference_number || "";
    editDescription.value = e.description || "";

    await populateVendorsSelect(e.vendor_id || "");

    // COA selects already filled globally; set selected values
    if (e.expense_account_id) editExpenseAccount.value = e.expense_account_id;
    if (e.paid_through_account_id) editExpensePaidThrough.value = e.paid_through_account_id;

    showExpenseEditModal();
  }

  async function saveEditedExpense() {
    if (!currentEditExpenseId) return;
    hideResult(expenseEditMsg);

    const payload = {
      date: editExpenseDate.value || undefined,
      amount: editExpenseAmount.value ? Number(editExpenseAmount.value) : undefined,
      vendor_id: editVendorId.value || undefined,
      reference_number: editReferenceNumber.value || undefined,
      description: editDescription.value || undefined,
      expense_account_id: editExpenseAccount.value || undefined,
      paid_through_account_id: editExpensePaidThrough.value || undefined,
    };

    try {
      const res = await fetch("/expenses/update/" + encodeURIComponent(currentEditExpenseId), {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const out = await res.json();
      if (!res.ok || !out.ok) {
        showResult(expenseEditMsg, "error", "Update failed:\n" + JSON.stringify(out, null, 2));
        return;
      }
      showResult(expenseEditMsg, "success", "Updated successfully.");
      await loadZohoExpenses();
    } catch (err) {
      showResult(expenseEditMsg, "error", String(err));
    }
  }

  async function deleteEditedExpense() {
    if (!currentEditExpenseId) return;
    const ok = confirm("Delete this expense in Zoho? This cannot be undone.");
    if (!ok) return;

    expenseEditMsg.classList.add("hidden");

    const res = await fetch("/expenses/delete/" + encodeURIComponent(currentEditExpenseId), { method: "DELETE" });
    let out = null;
    try { out = await res.json(); } catch { out = null; }

    if (!res.ok) {
      showResult(expenseEditMsg, "error", "Delete failed:\n" + (out ? JSON.stringify(out, null, 2) : res.statusText));
      return;
    }

    showResult(expenseEditMsg, "success", "Deleted successfully.");
    await loadZohoExpenses();
    setTimeout(hideExpenseEditModal, 600);
  }

  expenseSaveBtn.addEventListener("click", saveEditedExpense);
  expenseDeleteBtn.addEventListener("click", deleteEditedExpense);

</script>

</body>
</html>

