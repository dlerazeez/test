<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Assets & Expenses</title>
  <link rel="stylesheet" href="/static/style.css?v=40">
</head>
<body>

<div class="layout">

  <!-- Left sidebar -->
  <aside class="sidebar">
    <div class="sidebarCard">
      <div class="sidebarTitle">Navigation</div>
      <button id="navHome" class="navBtn active" type="button">Home</button>
      <button id="navAssets" class="navBtn" type="button">Assets</button>
      <button id="navExpenses" class="navBtn" type="button">Expenses</button>
    </div>
  </aside>

  <div class="content">

    <!-- Blank / Home -->
    <section id="homeSection" class="section">
      <div class="blank">
        <!-- Intentionally blank content area -->
      </div>
    </section>

    <!-- ASSETS SECTION -->
    <section id="assetsSection" class="section hidden">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h1>Create Fixed Asset</h1>
            <div class="subtitle">Draft asset will be created in Zoho Books</div>
          </div>
          <div class="badge">Assets</div>
        </div>

        <div class="hr"></div>

        <form id="assetForm">
          <div class="formGrid">
            <div class="field full">
              <label>Asset Name</label>
              <input id="asset_name" required>
            </div>

            <div class="field">
              <label>Asset Category</label>
              <select id="asset_category" required>
                <option value="COMPUTERS">Computers & Electronics</option>
                <option value="FURNITURE">Furniture & Equipment</option>
              </select>
            </div>

            <div class="field">
              <label>Purchase Cost</label>
              <input type="number" id="asset_cost" required>
            </div>

            <div class="field">
              <label>Purchase Date</label>
              <input type="date" id="purchase_date" required>
            </div>

            <div class="field">
              <label>Depreciation Start Date</label>
              <input type="date" id="depreciation_start_date" required>
            </div>

            <div class="field">
              <label>Useful Life (Months)</label>
              <input type="number" id="useful_life_months" required>
            </div>

            <div class="field full">
              <label>Salvage Value</label>
              <input type="number" id="salvage_value" value="0">
            </div>
          </div>

          <div class="actions">
            <button id="assetSubmitBtn" class="primary" type="submit">Create Asset</button>
          </div>
        </form>

        <div id="assetResult" class="result hidden"></div>
      </div>
    </section>

    <!-- EXPENSES SECTION -->
    <section id="expensesSection" class="section hidden">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h1>Expenses</h1>
            <div class="subtitle">Create pending expenses, retrieve posted expenses, and manage approvals later</div>
          </div>
          <div class="badge">Expenses</div>
        </div>

        <div class="hr"></div>

        <div class="moduleTabs">
          <button id="btnExpCreate" class="tabBtn active" type="button">Create Expense</button>
          <button id="btnExpRetrieve" class="tabBtn" type="button">Retrieve Expenses</button>
          <button id="btnExpPending" class="tabBtn" type="button">Pending Expenses</button>
        </div>

        <!-- CREATE (Pending) -->
        <section id="expCreatePanel" class="panel">
          <form id="expenseForm">
            <div class="formGrid">

              <div class="field">
                <label>Date</label>
                <input type="date" id="exp_date" required>
              </div>

              <div class="field">
                <label>Amount</label>
                <input type="number" step="0.01" id="exp_amount" required>
              </div>

              <div class="field">
                <label>Expense Account</label>
                <select id="exp_account_id" required>
                  <option value="">Loading…</option>
                </select>
                <div class="hint" id="exp_account_hint"></div>
              </div>

              <div class="field">
                <label>Paid Through</label>
                <select id="exp_paid_through_account_id" required>
                  <option value="">Loading…</option>
                </select>
                <div class="hint" id="paid_through_hint"></div>
              </div>

              <div class="field full">
                <label>Reference</label>
                <input id="exp_reference" placeholder="Optional">
              </div>

              <div class="field full">
                <label>Notes</label>
                <input id="exp_notes" placeholder="Optional">
              </div>

              <div class="field full">
                <label>Vendor (optional)</label>
                <select id="exp_vendor_id">
                  <option value="">No vendor</option>
                </select>
              </div>

              <div class="field full">
                <label>Attachment (optional)</label>
                <input type="file" id="exp_receipt" accept="image/*,application/pdf">
              </div>

            </div>

            <div class="actions">
              <button id="expenseSubmitBtn" class="primary" type="submit">Create Pending Expense</button>
            </div>
          </form>

          <div id="expenseResult" class="result hidden"></div>
        </section>

        <!-- RETRIEVE (Zoho posted) -->
        <section id="expRetrievePanel" class="panel hidden">
          <div class="row">
            <div class="field inlineField">
              <label>From</label>
              <input type="date" id="zoho_from">
            </div>
            <div class="field inlineField">
              <label>To</label>
              <input type="date" id="zoho_to">
            </div>
            <button id="expenseListBtn" type="button" class="secondary">Retrieve Expenses</button>
          </div>

          <div id="zohoResult" class="result hidden"></div>

          <div id="expenseTableWrap" class="tableWrap hidden">
            <table class="table" id="expenseTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Vendor</th>
                  <th>Reference</th>
                  <th>Receipt / Attach</th>
                  <th>View / Edit</th>
                </tr>
              </thead>
              <tbody id="expenseTableBody"></tbody>
            </table>
          </div>
        </section>

        <!-- PENDING -->
        <section id="expPendingPanel" class="panel hidden">
          <div class="row">
            <div class="field inlineField">
              <label>From</label>
              <input type="date" id="pending_from">
            </div>
            <div class="field inlineField">
              <label>To</label>
              <input type="date" id="pending_to">
            </div>
            <button id="pendingListBtn" type="button" class="secondary">Retrieve Pending</button>
          </div>

          <div id="pendingResult" class="result hidden"></div>

          <div id="pendingTableWrap" class="tableWrap hidden">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Vendor</th>
                  <th>Reference</th>
                  <th>Attachments</th>
                  <th>View / Edit</th>
                </tr>
              </thead>
              <tbody id="pendingTableBody"></tbody>
            </table>
          </div>
        </section>

      </div>
    </section>

  </div>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal hidden">
  <div class="modalCard">
    <div class="modalHeader">
      <div>
        <div class="modalTitle">Edit Expense</div>
        <div class="modalSub" id="editMeta"></div>
      </div>
      <button id="editClose" class="btnSmall secondary" type="button">Close</button>
    </div>

    <div class="hr"></div>

    <div class="formGrid">
      <div class="field">
        <label>Date</label>
        <input type="date" id="edit_date">
      </div>

      <div class="field">
        <label>Amount</label>
        <input type="number" step="0.01" id="edit_amount">
      </div>

      <div class="field">
        <label>Expense Account</label>
        <select id="edit_account_id"></select>
      </div>

      <div class="field">
        <label>Paid Through</label>
        <select id="edit_paid_through_account_id"></select>
      </div>

      <div class="field full">
        <label>Reference</label>
        <input id="edit_reference">
      </div>

      <div class="field full">
        <label>Notes</label>
        <input id="edit_notes">
      </div>

      <div class="field full">
        <label>Vendor</label>
        <select id="edit_vendor_id"></select>
      </div>
    </div>

    <div class="actions">
      <button id="editSave" class="primary" type="button">Save Changes</button>
    </div>

    <div id="editResult" class="result hidden"></div>
  </div>
</div>

<input type="file" id="hiddenFilePicker" class="hidden" accept="image/*,application/pdf">

<script>
  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function setTodayIfEmpty(inputEl) {
    if (!inputEl.value) {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      inputEl.value = `${yyyy}-${mm}-${dd}`;
    }
  }

  function showResult(el, type, text) {
    el.classList.remove("hidden");
    el.classList.remove("success", "error");
    if (type) el.classList.add(type);
    el.textContent = text;
  }

  function fillSelect(selectEl, accounts, placeholder) {
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder || "Select…";
    selectEl.appendChild(opt0);

    (accounts || []).forEach(a => {
      const opt = document.createElement("option");
      opt.value = a.account_id;
      const code = a.account_code ? `${a.account_code} — ` : "";
      const cur = a.currency ? ` (${a.currency})` : "";
      opt.textContent = `${code}${a.account_name}${cur}`;
      opt.dataset.code = a.account_code || "";
      opt.dataset.currency = a.currency || "";
      opt.dataset.type = a.account_type || "";
      selectEl.appendChild(opt);
    });
  }

  function fillVendors(selectEl, vendors) {
    selectEl.innerHTML = `<option value="">No vendor</option>`;
    (vendors || []).forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.contact_id || "";
      opt.textContent = v.contact_name || v.contact_id || "";
      selectEl.appendChild(opt);
    });
  }

  function updateHint(selectEl, hintEl) {
    const opt = selectEl.options[selectEl.selectedIndex];
    if (!opt || !opt.value) { hintEl.textContent = ""; return; }
    const code = opt.dataset.code ? `Code: ${opt.dataset.code}` : "";
    const type = opt.dataset.type ? `Type: ${opt.dataset.type}` : "";
    const cur = opt.dataset.currency ? `Currency: ${opt.dataset.currency}` : "";
    hintEl.textContent = [code, type, cur].filter(Boolean).join(" • ");
  }

  // Navigation
  const homeSection = document.getElementById("homeSection");
  const assetsSection = document.getElementById("assetsSection");
  const expensesSection = document.getElementById("expensesSection");

  const navHome = document.getElementById("navHome");
  const navAssets = document.getElementById("navAssets");
  const navExpenses = document.getElementById("navExpenses");

  function setActiveNav(btn) {
    [navHome, navAssets, navExpenses].forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  }

  function showOnly(section) {
    [homeSection, assetsSection, expensesSection].forEach(s => s.classList.add("hidden"));
    section.classList.remove("hidden");
  }

  navHome.addEventListener("click", () => { setActiveNav(navHome); showOnly(homeSection); });
  navAssets.addEventListener("click", () => { setActiveNav(navAssets); showOnly(assetsSection); });
  navExpenses.addEventListener("click", async () => {
    setActiveNav(navExpenses);
    showOnly(expensesSection);
    setTodayIfEmpty(document.getElementById("exp_date"));
    await Promise.all([loadCOADropdowns(), loadVendors()]);
  });

  // Assets
  const assetForm = document.getElementById("assetForm");
  const assetResult = document.getElementById("assetResult");
  const assetBtn = document.getElementById("assetSubmitBtn");

  assetForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    assetBtn.disabled = true;
    assetBtn.textContent = "Creating…";
    assetResult.classList.add("hidden");

    const payload = {
      asset_name: asset_name.value,
      asset_category: asset_category.value,
      asset_cost: Number(asset_cost.value),
      purchase_date: purchase_date.value,
      depreciation_start_date: depreciation_start_date.value,
      useful_life_months: Number(useful_life_months.value),
      salvage_value: Number(salvage_value.value)
    };

    try {
      const res = await fetch("/assets/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.ok) {
        showResult(assetResult, "success", `Asset created successfully (Asset No: ${data.asset_number})`);
        assetForm.reset();
      } else {
        throw new Error(JSON.stringify(data, null, 2));
      }
    } catch {
      showResult(assetResult, "error", "Failed to create asset. Please check inputs.");
    }

    assetBtn.disabled = false;
    assetBtn.textContent = "Create Asset";
  });

  // Expenses tabs
  const btnExpCreate = document.getElementById("btnExpCreate");
  const btnExpRetrieve = document.getElementById("btnExpRetrieve");
  const btnExpPending = document.getElementById("btnExpPending");

  const expCreatePanel = document.getElementById("expCreatePanel");
  const expRetrievePanel = document.getElementById("expRetrievePanel");
  const expPendingPanel = document.getElementById("expPendingPanel");

  function setExpenseTab(which) {
    [btnExpCreate, btnExpRetrieve, btnExpPending].forEach(b => b.classList.remove("active"));
    [expCreatePanel, expRetrievePanel, expPendingPanel].forEach(p => p.classList.add("hidden"));

    if (which === "create") { btnExpCreate.classList.add("active"); expCreatePanel.classList.remove("hidden"); }
    if (which === "retrieve") { btnExpRetrieve.classList.add("active"); expRetrievePanel.classList.remove("hidden"); }
    if (which === "pending") { btnExpPending.classList.add("active"); expPendingPanel.classList.remove("hidden"); }
  }

  btnExpCreate.addEventListener("click", () => setExpenseTab("create"));
  btnExpRetrieve.addEventListener("click", () => setExpenseTab("retrieve"));
  btnExpPending.addEventListener("click", () => setExpenseTab("pending"));

  // COA dropdowns (create form)
  const expAccountSelect = document.getElementById("exp_account_id");
  const paidThroughSelect = document.getElementById("exp_paid_through_account_id");
  const expAccountHint = document.getElementById("exp_account_hint");
  const paidThroughHint = document.getElementById("paid_through_hint");

  expAccountSelect.addEventListener("change", () => updateHint(expAccountSelect, expAccountHint));
  paidThroughSelect.addEventListener("change", () => updateHint(paidThroughSelect, paidThroughHint));

  let _coaExpense = [];
  let _coaPaid = [];
  let _vendors = [];

  async function loadCOADropdowns() {
    const r1 = await fetch("/coa/expense-accounts");
    const d1 = await r1.json();
    if (d1.ok) {
      _coaExpense = d1.accounts || [];
      fillSelect(expAccountSelect, _coaExpense, "Select expense account…");
    } else {
      expAccountSelect.innerHTML = `<option value="">COA not loaded</option>`;
    }

    const r2 = await fetch("/coa/paid-through-accounts");
    const d2 = await r2.json();
    if (d2.ok) {
      _coaPaid = d2.accounts || [];
      fillSelect(paidThroughSelect, _coaPaid, "Select paid through…");
    } else {
      paidThroughSelect.innerHTML = `<option value="">COA not loaded</option>`;
    }

    updateHint(expAccountSelect, expAccountHint);
    updateHint(paidThroughSelect, paidThroughHint);

    // also update modal selects if open
    fillSelect(document.getElementById("edit_account_id"), _coaExpense, "Select expense account…");
    fillSelect(document.getElementById("edit_paid_through_account_id"), _coaPaid, "Select paid through…");
  }

  async function loadVendors() {
    const sel = document.getElementById("exp_vendor_id");
    sel.innerHTML = `<option value="">Loading…</option>`;

    try {
      const res = await fetch("/vendors/list?page=1&per_page=200");
      const out = await res.json();
      if (!out.ok) throw new Error("failed");
      _vendors = out.vendors || [];
      fillVendors(sel, _vendors);
      fillVendors(document.getElementById("edit_vendor_id"), _vendors);
    } catch {
      sel.innerHTML = `<option value="">No vendor (failed to load)</option>`;
    }
  }

  // Create Pending Expense
  const expenseForm = document.getElementById("expenseForm");
  const expenseResult = document.getElementById("expenseResult");
  const expenseBtn = document.getElementById("expenseSubmitBtn");

  expenseForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    expenseBtn.disabled = true;
    expenseBtn.textContent = "Creating…";
    expenseResult.classList.add("hidden");

    const payload = {
      date: exp_date.value,
      account_id: expAccountSelect.value,
      paid_through_account_id: paidThroughSelect.value,
      amount: Number(exp_amount.value),
      notes: (exp_notes.value || "").trim(),
      reference_number: (exp_reference.value || "").trim(),
    };
    if (exp_vendor_id.value.trim()) payload.vendor_id = exp_vendor_id.value.trim();

    try {
      const res = await fetch("/pending-expenses/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out?.detail || out, null, 2));

      const pendingId = out.pending.id;

      // Optional attachment
      const file = exp_receipt.files && exp_receipt.files[0];
      if (file) {
        expenseBtn.textContent = "Uploading attachment…";
        const fd = new FormData();
        fd.append("file", file);
        const r2 = await fetch(`/pending-expenses/${encodeURIComponent(pendingId)}/attachments`, { method: "POST", body: fd });
        const d2 = await r2.json();
        if (!r2.ok || !d2.ok) throw new Error(JSON.stringify(d2?.detail || d2, null, 2));
      }

      showResult(expenseResult, "success", "Pending expense created successfully.");
      expenseForm.reset();
      setTodayIfEmpty(document.getElementById("exp_date"));
      await Promise.all([loadCOADropdowns(), loadVendors()]);
    } catch (err) {
      showResult(expenseResult, "error", "Failed:\n" + (err?.message || String(err)));
    }

    expenseBtn.disabled = false;
    expenseBtn.textContent = "Create Pending Expense";
  });

  // Zoho retrieve table
  const expenseListBtn = document.getElementById("expenseListBtn");
  const zohoResult = document.getElementById("zohoResult");
  const expenseTableWrap = document.getElementById("expenseTableWrap");
  const expenseTableBody = document.getElementById("expenseTableBody");
  const hiddenFilePicker = document.getElementById("hiddenFilePicker");

  function openZohoReceipt(expenseId) {
    window.open(`/expenses/${encodeURIComponent(expenseId)}/receipt`, "_blank");
  }

  async function attachZoho(expenseId) {
    hiddenFilePicker.value = "";
    hiddenFilePicker.onchange = async () => {
      const file = hiddenFilePicker.files && hiddenFilePicker.files[0];
      if (!file) return;

      const fd = new FormData();
      fd.append("file", file);

      const res = await fetch(`/expenses/${encodeURIComponent(expenseId)}/attachment`, { method: "POST", body: fd });
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out?.detail || out, null, 2));

      showResult(zohoResult, "success", "Attachment added (did not replace receipt).");
    };
    hiddenFilePicker.click();
  }

  async function loadZohoExpenses() {
    zohoResult.classList.add("hidden");
    expenseTableWrap.classList.add("hidden");
    expenseTableBody.innerHTML = "";

    const from = document.getElementById("zoho_from").value || null;
    const to = document.getElementById("zoho_to").value || null;

    try {
      const res = await fetch(`/expenses/list?page=1&per_page=50&filter_by=Status.All`);
      const out = await res.json();
      if (!out.ok) throw new Error("Zoho error");

      let list = out.data.expenses || [];

      // Client-side date filter on returned page
      if (from) list = list.filter(x => (x.date || "") >= from);
      if (to) list = list.filter(x => (x.date || "") <= to);

      if (!list.length) {
        showResult(zohoResult, "", "No expenses found for the selected date range (page 1).");
        return;
      }

      list.forEach((x) => {
        const tr = document.createElement("tr");
        const date = x.date || "";
        const amt = (x.total || x.amount || "") + (x.currency_code ? (" " + x.currency_code) : "");
        const vendor = x.vendor_name || x.customer_name || "";
        const reference = x.reference_number || "";

        const id = x.expense_id || "";

        tr.innerHTML = `
          <td>${escapeHtml(date)}</td>
          <td>${escapeHtml(String(amt))}</td>
          <td>${escapeHtml(String(vendor))}</td>
          <td>${escapeHtml(String(reference))}</td>
          <td class="btnCell">
            <button class="btnSmall secondary" data-action="attach" data-id="${escapeHtml(id)}">Attach</button>
            <button class="btnSmall" data-action="open" data-id="${escapeHtml(id)}">Open</button>
          </td>
          <td class="btnCell">
            <button class="btnSmall" data-action="editZoho" data-id="${escapeHtml(id)}">View/Edit</button>
          </td>
        `;

        tr.querySelectorAll("button").forEach(btn => {
          const action = btn.getAttribute("data-action");
          const eid = btn.getAttribute("data-id");

          btn.addEventListener("click", async () => {
            try {
              if (action === "open") return openZohoReceipt(eid);
              if (action === "attach") return attachZoho(eid);
              if (action === "editZoho") return openEditModal("zoho", eid);
            } catch (err) {
              showResult(zohoResult, "error", "Failed:\n" + (err?.message || String(err)));
            }
          });
        });

        expenseTableBody.appendChild(tr);
      });

      expenseTableWrap.classList.remove("hidden");
    } catch {
      showResult(zohoResult, "error", "Failed to load Zoho expenses.");
    }
  }

  expenseListBtn.addEventListener("click", loadZohoExpenses);

  // Pending table
  const pendingListBtn = document.getElementById("pendingListBtn");
  const pendingResult = document.getElementById("pendingResult");
  const pendingTableWrap = document.getElementById("pendingTableWrap");
  const pendingTableBody = document.getElementById("pendingTableBody");

  async function attachPending(pendingId) {
    hiddenFilePicker.value = "";
    hiddenFilePicker.onchange = async () => {
      const file = hiddenFilePicker.files && hiddenFilePicker.files[0];
      if (!file) return;

      const fd = new FormData();
      fd.append("file", file);

      const res = await fetch(`/pending-expenses/${encodeURIComponent(pendingId)}/attachments`, { method: "POST", body: fd });
      const out = await res.json();
      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out?.detail || out, null, 2));

      showResult(pendingResult, "success", "Attachment added to pending expense.");
      await loadPending();
    };
    hiddenFilePicker.click();
  }

  async function openPendingLatest(pendingId) {
    const res = await fetch(`/pending-expenses/by-id/${encodeURIComponent(pendingId)}`);
    const out = await res.json();
    const atts = out.attachments || [];
    if (!atts.length) {
      showResult(pendingResult, "", "No attachments found for this pending expense.");
      return;
    }
    const latest = atts[0];
    window.open(`/pending-expenses/${encodeURIComponent(pendingId)}/attachments/${encodeURIComponent(latest.id)}`, "_blank");
  }

  async function loadPending() {
    pendingResult.classList.add("hidden");
    pendingTableWrap.classList.add("hidden");
    pendingTableBody.innerHTML = "";

    const from = document.getElementById("pending_from").value || "";
    const to = document.getElementById("pending_to").value || "";

    const qs = new URLSearchParams();
    qs.set("status", "PENDING");
    if (from) qs.set("date_from", from);
    if (to) qs.set("date_to", to);

    try {
      const res = await fetch(`/pending-expenses/list?` + qs.toString());
      const out = await res.json();
      if (!out.ok) throw new Error("pending error");

      const list = out.pending || [];
      if (!list.length) {
        showResult(pendingResult, "", "No pending expenses found.");
        return;
      }

      list.forEach((x) => {
        const tr = document.createElement("tr");
        const date = x.date || "";
        const amt = x.amount || "";
        const vendor = x.vendor_id || "";
        const reference = x.reference_number || "";
        const id = x.id || "";

        tr.innerHTML = `
          <td>${escapeHtml(date)}</td>
          <td>${escapeHtml(String(amt))}</td>
          <td>${escapeHtml(String(vendor))}</td>
          <td>${escapeHtml(String(reference))}</td>
          <td class="btnCell">
            <button class="btnSmall secondary" data-action="attach" data-id="${escapeHtml(id)}">Attach</button>
            <button class="btnSmall" data-action="open" data-id="${escapeHtml(id)}">Open</button>
          </td>
          <td class="btnCell">
            <button class="btnSmall" data-action="editPending" data-id="${escapeHtml(id)}">View/Edit</button>
          </td>
        `;

        tr.querySelectorAll("button").forEach(btn => {
          const action = btn.getAttribute("data-action");
          const eid = btn.getAttribute("data-id");

          btn.addEventListener("click", async () => {
            try {
              if (action === "attach") return attachPending(eid);
              if (action === "open") return openPendingLatest(eid);
              if (action === "editPending") return openEditModal("pending", eid);
            } catch (err) {
              showResult(pendingResult, "error", "Failed:\n" + (err?.message || String(err)));
            }
          });
        });

        pendingTableBody.appendChild(tr);
      });

      pendingTableWrap.classList.remove("hidden");
    } catch {
      showResult(pendingResult, "error", "Failed to load pending expenses.");
    }
  }

  pendingListBtn.addEventListener("click", loadPending);

  // Edit Modal
  const editModal = document.getElementById("editModal");
  const editClose = document.getElementById("editClose");
  const editSave = document.getElementById("editSave");
  const editResult = document.getElementById("editResult");
  const editMeta = document.getElementById("editMeta");

  let _editMode = null; // "zoho" | "pending"
  let _editId = null;

  function openModal() { editModal.classList.remove("hidden"); }
  function closeModal() { editModal.classList.add("hidden"); editResult.classList.add("hidden"); }

  editClose.addEventListener("click", closeModal);

  async function openEditModal(mode, id) {
    _editMode = mode;
    _editId = id;
    editResult.classList.add("hidden");

    // Ensure dropdowns exist
    fillSelect(document.getElementById("edit_account_id"), _coaExpense, "Select expense account…");
    fillSelect(document.getElementById("edit_paid_through_account_id"), _coaPaid, "Select paid through…");
    fillVendors(document.getElementById("edit_vendor_id"), _vendors);

    if (mode === "zoho") {
      editMeta.textContent = "Zoho Expense ID: " + id;
      const res = await fetch("/expenses/by-id/" + encodeURIComponent(id));
      const data = await res.json();
      const e = data.expense || {};

      document.getElementById("edit_date").value = e.date || "";
      document.getElementById("edit_amount").value = e.amount || e.total || "";
      document.getElementById("edit_account_id").value = e.account_id || "";
      document.getElementById("edit_paid_through_account_id").value = e.paid_through_account_id || "";
      document.getElementById("edit_vendor_id").value = e.vendor_id || "";
      document.getElementById("edit_reference").value = e.reference_number || "";
      document.getElementById("edit_notes").value = e.description || "";
    } else {
      editMeta.textContent = "Pending ID: " + id;
      const res = await fetch("/pending-expenses/by-id/" + encodeURIComponent(id));
      const data = await res.json();
      const e = data.pending || {};

      document.getElementById("edit_date").value = e.date || "";
      document.getElementById("edit_amount").value = e.amount || "";
      document.getElementById("edit_account_id").value = e.account_id || "";
      document.getElementById("edit_paid_through_account_id").value = e.paid_through_account_id || "";
      document.getElementById("edit_vendor_id").value = e.vendor_id || "";
      document.getElementById("edit_reference").value = e.reference_number || "";
      document.getElementById("edit_notes").value = e.notes || "";
    }

    openModal();
  }

  editSave.addEventListener("click", async () => {
    editSave.disabled = true;
    editSave.textContent = "Saving…";
    editResult.classList.add("hidden");

    const payload = {
      date: document.getElementById("edit_date").value,
      amount: Number(document.getElementById("edit_amount").value),
      account_id: document.getElementById("edit_account_id").value,
      paid_through_account_id: document.getElementById("edit_paid_through_account_id").value,
      vendor_id: document.getElementById("edit_vendor_id").value,
      reference_number: document.getElementById("edit_reference").value.trim(),
      notes: document.getElementById("edit_notes").value.trim(),
    };

    try {
      let res, out;
      if (_editMode === "zoho") {
        res = await fetch("/expenses/update/" + encodeURIComponent(_editId), {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        out = await res.json();
      } else {
        res = await fetch("/pending-expenses/update/" + encodeURIComponent(_editId), {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        out = await res.json();
      }

      if (!res.ok || !out.ok) throw new Error(JSON.stringify(out?.detail || out, null, 2));
      showResult(editResult, "success", "Saved successfully.");

      // refresh tables if visible
      if (_editMode === "zoho") await loadZohoExpenses();
      if (_editMode === "pending") await loadPending();

    } catch (err) {
      showResult(editResult, "error", "Failed:\n" + (err?.message || String(err)));
    }

    editSave.disabled = false;
    editSave.textContent = "Save Changes";
  });

  // Defaults
  setTodayIfEmpty(document.getElementById("purchase_date"));
  setTodayIfEmpty(document.getElementById("depreciation_start_date"));
  setTodayIfEmpty(document.getElementById("exp_date"));

  // Start blank
  showOnly(homeSection);
</script>

</body>
</html>
